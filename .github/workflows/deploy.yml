name: Build, Push, and Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-main
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: deployguard-analysis
  K8S_NAMESPACE: deployguard
  DEPLOYMENT_NAME: deployguard-analysis
  CONTAINER_NAME: deployguard-analysis

permissions:
  id-token: write
  contents: read

jobs:
  build-push-deploy:
    name: Build, Push, and Deploy to Kubernetes
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ AWS OIDC ì¸ì¦
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::189060532132:role/deployguard-analysis-github-role
          aws-region: ${{ env.AWS_REGION }}

      # 3ï¸âƒ£ ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4ï¸âƒ£ Git SHA ì¶”ì¶œ
      - name: Extract Git metadata
        id: meta
        run: |
          echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ Docker ë¹Œë“œ
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG_LATEST: latest
          IMAGE_TAG_SHA: ${{ steps.meta.outputs.sha_short }}
        run: |
          docker build --pull \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_LATEST \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_SHA \
            .

      # 6ï¸âƒ£ ECR í‘¸ì‹œ
      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG_LATEST: latest
          IMAGE_TAG_SHA: ${{ steps.meta.outputs.sha_short }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_LATEST
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_SHA

      # 7ï¸âƒ£ kubectl ì„¤ì¹˜
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      # 8ï¸âƒ£ kubeconfig ì„¤ì •
      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_BASE64: ${{ secrets.KUBE_CONFIG_BASE64 }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG_BASE64" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # 9ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ì—°ê²° í™•ì¸
      - name: Verify cluster connectivity
        run: |
          kubectl cluster-info
          kubectl get nodes

      # ğŸ”Ÿ Manifest ì ìš© + SHA ì´ë¯¸ì§€ë¡œ ê°•ì œ êµì²´
      - name: Deploy to Kubernetes
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG_SHA: ${{ steps.meta.outputs.sha_short }}
        run: |
          # ê¸°ë³¸ ë¦¬ì†ŒìŠ¤ ì ìš©
          kubectl apply -f k8s/ -n $K8S_NAMESPACE

          # SHA íƒœê·¸ë¡œ ì´ë¯¸ì§€ ê°•ì œ ì—…ë°ì´íŠ¸
          kubectl set image deployment/$DEPLOYMENT_NAME \
            $CONTAINER_NAME=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_SHA \
            -n $K8S_NAMESPACE

          # ë¡¤ì•„ì›ƒ ì™„ë£Œ ëŒ€ê¸°
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $K8S_NAMESPACE

      # 1ï¸âƒ£1ï¸âƒ£ ë°°í¬ ìƒíƒœ ì¶œë ¥
      - name: Verify deployment
        run: |
          kubectl get pods -n $K8S_NAMESPACE
          kubectl get deployment $DEPLOYMENT_NAME -n $K8S_NAMESPACE

      # 1ï¸âƒ£2ï¸âƒ£ kubeconfig ì •ë¦¬
      - name: Cleanup kubeconfig
        if: always()
        run: |
          rm -f $HOME/.kube/config

      # 1ï¸âƒ£3ï¸âƒ£ ê²°ê³¼ ì¶œë ¥
      - name: Output deployment summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG_SHA: ${{ steps.meta.outputs.sha_short }}
        run: |
          echo "--------------------------------------"
          echo "Deployment completed successfully"
          echo "Repository: $ECR_REGISTRY/$ECR_REPOSITORY"
          echo "Deployed Tag: $IMAGE_TAG_SHA"
          echo "Namespace: $K8S_NAMESPACE"
          echo "--------------------------------------"